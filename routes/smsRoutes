// routes/smsRoutes.js - Complete SMS notification routes
const express = require('express');
const router = express.Router();
const smsService = require('../services/smsService');
const { protect, authorize } = require('../middleware/auth');

// ============================================
// Admin Notifications
// ============================================

// @desc    Send admin notification when new order is placed
// @route   POST /api/sms/admin-notification
// @access  Private
router.post('/admin-notification', protect, async (req, res) => {
  try {
    const { orderNumber, customerName, totalAmount, orderDateTime } = req.body;
    
    // Admin phone numbers
    const adminPhones = ['9539387240', '9388808825'];
    
    const deliveryDate = new Date(orderDateTime).toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    const message = `üîî New Order Alert!\n\nOrder: ${orderNumber}\nCustomer: ${customerName}\nAmount: ‚Çπ${totalAmount}\nDelivery: ${deliveryDate}\n\nLogin to confirm: sachinfoodskundara.com/admin/orders`;
    
    // Send to all admin numbers
    const results = await Promise.all(
      adminPhones.map(phone => smsService.sendSMS(phone, message))
    );
    
    console.log('‚úÖ Admin notifications sent:', results);
    
    res.json({ 
      success: true, 
      message: 'Admin notified',
      sent: results.filter(r => r.success).length,
      total: adminPhones.length
    });
  } catch (error) {
    console.error('‚ùå Admin notification error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send admin notification',
      error: error.message 
    });
  }
});

// ============================================
// Customer Notifications
// ============================================

// @desc    Send order confirmation SMS to customer
// @route   POST /api/sms/order-confirmed
// @access  Private/Admin
router.post('/order-confirmed', protect, authorize('admin'), async (req, res) => {
  try {
    const { phone, orderNumber, deliveryDate, customerName } = req.body;
    
    const formattedDate = new Date(deliveryDate).toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    const message = `‚úÖ Order Confirmed!\n\nHi ${customerName}, your order ${orderNumber} has been confirmed by Sachin Foods.\n\nDelivery: ${formattedDate}\n\nWe'll prepare fresh Chappathy, Appam & more for you!\n\nContact: 9539387240, 9388808825`;
    
    const result = await smsService.sendSMS(phone, message);
    
    if (result.success) {
      console.log('‚úÖ Order confirmation SMS sent to:', phone);
      res.json({ 
        success: true, 
        message: 'Customer notified of order confirmation' 
      });
    } else {
      throw new Error('SMS sending failed');
    }
  } catch (error) {
    console.error('‚ùå Order confirmation SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send confirmation SMS',
      error: error.message 
    });
  }
});

// @desc    Send order denial SMS to customer
// @route   POST /api/sms/order-denied
// @access  Private/Admin
router.post('/order-denied', protect, authorize('admin'), async (req, res) => {
  try {
    const { phone, orderNumber, reason, customerName } = req.body;
    
    const message = `‚ùå Order Status Update\n\nHi ${customerName}, we're sorry but we cannot process order ${orderNumber} at this time.\n\n${reason ? `Reason: ${reason}\n\n` : ''}For assistance or to place a new order, please call:\nüìû 9539387240, 9388808825\n\nSachin Foods, Kundara`;
    
    const result = await smsService.sendSMS(phone, message);
    
    if (result.success) {
      console.log('‚úÖ Order denial SMS sent to:', phone);
      res.json({ 
        success: true, 
        message: 'Customer notified of order denial' 
      });
    } else {
      throw new Error('SMS sending failed');
    }
  } catch (error) {
    console.error('‚ùå Order denial SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send denial SMS',
      error: error.message 
    });
  }
});

// @desc    Send order status update SMS
// @route   POST /api/sms/order-status
// @access  Private/Admin
router.post('/order-status', protect, authorize('admin'), async (req, res) => {
  try {
    const { phone, orderNumber, status, customerName } = req.body;
    
    const statusMessages = {
      preparing: `üç≥ Order Update\n\nHi ${customerName}! We're preparing fresh food for your order ${orderNumber}.\n\nExpected delivery as scheduled.\n\nSachin Foods, Kundara\nüìû 9539387240`,
      ready: `‚úÖ Order Ready!\n\nHi ${customerName}! Your order ${orderNumber} is ready and will be delivered on time.\n\nFresh Chappathy, Appam & more!\n\nSachin Foods\nüìû 9539387240`,
      delivered: `üéâ Order Delivered!\n\nThank you ${customerName} for choosing Sachin Foods!\n\nOrder ${orderNumber} delivered.\n\nHope you enjoyed our Chappathy, Appam & bakery items!\n\nüìû 9539387240, 9388808825`,
    };
    
    const message = statusMessages[status] || 
      `Order ${orderNumber} status: ${status}\n\nSachin Foods\nüìû 9539387240`;
    
    const result = await smsService.sendSMS(phone, message);
    
    if (result.success) {
      console.log(`‚úÖ Status update SMS (${status}) sent to:`, phone);
      res.json({ 
        success: true, 
        message: `Customer notified of ${status} status` 
      });
    } else {
      throw new Error('SMS sending failed');
    }
  } catch (error) {
    console.error('‚ùå Status update SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send status update SMS',
      error: error.message 
    });
  }
});

// @desc    Send invoice via SMS
// @route   POST /api/sms/invoice
// @access  Private/Admin
router.post('/invoice', protect, authorize('admin'), async (req, res) => {
  try {
    const { phone, orderNumber, invoiceUrl, customerName, totalAmount } = req.body;
    
    const message = `üìÑ Invoice Ready\n\nHi ${customerName}!\n\nYour invoice for Order ${orderNumber} is ready.\n\nTotal: ‚Çπ${totalAmount}\n\nDownload: ${invoiceUrl}\n\nThank you!\nSachin Foods, Kundara\nüìû 9539387240`;
    
    const result = await smsService.sendSMS(phone, message);
    
    if (result.success) {
      console.log('‚úÖ Invoice SMS sent to:', phone);
      res.json({ 
        success: true, 
        message: 'Invoice SMS sent to customer' 
      });
    } else {
      throw new Error('SMS sending failed');
    }
  } catch (error) {
    console.error('‚ùå Invoice SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send invoice SMS',
      error: error.message 
    });
  }
});

// @desc    Send payment confirmation SMS
// @route   POST /api/sms/payment-confirmation
// @access  Private
router.post('/payment-confirmation', protect, async (req, res) => {
  try {
    const { phone, amount, orderNumber, customerName, balance } = req.body;
    
    const message = `üí∞ Payment Received\n\nHi ${customerName}!\n\nPayment of ‚Çπ${amount} received for order ${orderNumber}.\n\n${balance > 0 ? `Balance: ‚Çπ${balance}\n\n` : ''}Thank you!\n\nSachin Foods, Kundara\nüìû 9539387240`;
    
    const result = await smsService.sendSMS(phone, message);
    
    if (result.success) {
      console.log('‚úÖ Payment confirmation SMS sent to:', phone);
      res.json({ 
        success: true, 
        message: 'Payment confirmation sent' 
      });
    } else {
      throw new Error('SMS sending failed');
    }
  } catch (error) {
    console.error('‚ùå Payment confirmation SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send payment confirmation',
      error: error.message 
    });
  }
});

// @desc    Send delivery reminder SMS
// @route   POST /api/sms/delivery-reminder
// @access  Private/Admin
router.post('/delivery-reminder', protect, authorize('admin'), async (req, res) => {
  try {
    const { phone, orderNumber, deliveryDate, customerName } = req.body;
    
    const formattedDate = new Date(deliveryDate).toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    const message = `‚è∞ Delivery Reminder\n\nHi ${customerName}!\n\nYour order ${orderNumber} is scheduled for delivery on ${formattedDate}.\n\nWe're ready with fresh food!\n\nSachin Foods, Kundara\nüìû 9539387240`;
    
    const result = await smsService.sendSMS(phone, message);
    
    if (result.success) {
      console.log('‚úÖ Delivery reminder SMS sent to:', phone);
      res.json({ 
        success: true, 
        message: 'Delivery reminder sent' 
      });
    } else {
      throw new Error('SMS sending failed');
    }
  } catch (error) {
    console.error('‚ùå Delivery reminder SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to send delivery reminder',
      error: error.message 
    });
  }
});

// @desc    Test SMS endpoint (development only)
// @route   POST /api/sms/test
// @access  Private/Admin
router.post('/test', protect, authorize('admin'), async (req, res) => {
  try {
    const { phone, message } = req.body;
    
    if (!phone || !message) {
      return res.status(400).json({
        success: false,
        message: 'Phone and message are required'
      });
    }
    
    const result = await smsService.sendSMS(phone, message);
    
    res.json({ 
      success: result.success, 
      message: result.message,
      details: result
    });
  } catch (error) {
    console.error('‚ùå Test SMS error:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Test SMS failed',
      error: error.message 
    });
  }
});

module.exports = router;